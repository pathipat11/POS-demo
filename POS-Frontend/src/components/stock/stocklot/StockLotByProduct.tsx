import React, { useState } from "react";
import StockLotTable from "./StockLotTable";
import StockLotModal from "./StockLotModal";

interface Props {
    data: any;
    currentPage?: number;
    itemsPerPage?: number;
}

const StockLotByProduct: React.FC<Props> = ({
    data,
    currentPage = 1,
    itemsPerPage = 10,
}) => {
    const [selectedProduct, setSelectedProduct] = useState<any>(null);

    const refreshData = async () => {
        console.log("üîÑ Refreshing stock lot data...");
    };

    const lotsArray = Array.isArray(data.lots) ? data.lots : data.lots?.data || [];
    const stocksArray = Array.isArray(data.stocks) ? data.stocks : data.stocks?.data || [];

    // ‚úÖ Normalize stock data
    const normalizedStocks = stocksArray.map((p: any) => ({
        _id: p._id,
        name: p.productId?.name || p.name || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤",
        barcode: p.productId?.barcode || p.barcode || "-",
        supplier: p.supplierId?.companyName || p.supplier || "-",
        warehouse: p.location?.name || "-",
        threshold: p.threshold || 0,
        totalQuantity: p.totalQuantity || 0,
        status: p.status || "",
        costPrice: p.costPrice || 0,
        salePrice: p.salePrice || 0,
        lots: [],
    }));

    // ‚úÖ ‡∏£‡∏ß‡∏° remainingQty ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞ product
    const productGroups = normalizedStocks.map((p: any) => {
        const relatedLots = lotsArray.filter((lot: any) => lot.barcode === p.barcode);
        const totalRemainingQty = relatedLots.reduce(
            (sum: number, lot: any) => sum + (Number(lot.remainingQty) || 0),
            0
        );

        return {
            ...p,
            lotCount: relatedLots.length,
            lots: relatedLots,
            totalRemainingQty, // ‚úÖ ‡∏£‡∏ß‡∏°‡∏à‡∏≤‡∏Å remainingQty ‡∏Ç‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏•‡πá‡∏≠‡∏ï
        };
    });

    const startIndex = (currentPage - 1) * itemsPerPage;

    return (
        <div className="stocklot-section">
            <h2 className="section-title">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
            <div className="table-scroll-container">
                <StockLotTable
                    headers={[
                        "‡∏•‡∏≥‡∏î‡∏±‡∏ö",
                        "‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤",
                        "Barcode",
                        "‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤",
                        "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (‡∏à‡∏≤‡∏Å‡∏•‡πá‡∏≠‡∏ï)",
                        "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏•‡πá‡∏≠‡∏ï",
                        "‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£",
                    ]}
                    data={productGroups.map((p: any, index: number) => [
                        startIndex + index + 1,
                        p.name,
                        p.barcode,
                        p.warehouse,
                        `${p.totalRemainingQty} ‡∏ä‡∏¥‡πâ‡∏ô`, // ‚úÖ ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å remainingQty ‡∏£‡∏ß‡∏°
                        p.lotCount,
                        <button className="table-btn" onClick={() => setSelectedProduct(p)}>
                            ‡∏î‡∏π‡∏•‡πá‡∏≠‡∏ï
                        </button>,
                    ])}
                />
            </div>

            {selectedProduct && (
                <StockLotModal
                    product={selectedProduct}
                    lots={selectedProduct.lots}
                    onClose={() => setSelectedProduct(null)}
                    refreshData={refreshData}
                />
            )}
        </div>
    );
};

export default StockLotByProduct;
